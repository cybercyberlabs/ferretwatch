class BackgroundService{constructor(){this.tabResults=new Map,this.apiEndpoints=new Map,this.settings=null,this.init()}init(){console.log("ðŸ”§ Background service worker initializing..."),this.setupMessageListeners(),this.setupStorageListeners(),this.setupTabListeners(),this.loadSettings().then((()=>{console.log("âœ… Background service worker ready")}))}async loadSettings(){try{const e="undefined"!=typeof browser?browser:chrome,t=await e.storage.local.get("userSettings");this.settings=t.userSettings||this.getDefaultSettings()}catch(e){console.error("Failed to load settings:",e),this.settings=this.getDefaultSettings()}}getDefaultSettings(){return{enabledCategories:["aws","github","api-keys","databases","certificates"],riskThreshold:"medium",enableNotifications:!0,enableHighlighting:!1,enableSoundAlerts:!1,scanDelay:1e3,trustedDomains:[],cloudBucketScanning:{enabled:!0,providers:{aws:!0,gcp:!0,azure:!0,digitalocean:!0,alibaba:!0},testTimeout:5e3,maxConcurrentTests:3,testPublicAccess:!0}}}setupMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,s)=>(this.handleMessage(e,t,s),!0)))}async handleMessage(e,t,s){try{switch(e.type){case"SCAN_COMPLETE":await this.handleScanComplete(e.data,t.tab?.id),s({success:!0});break;case"GET_SETTINGS":s({settings:this.settings});break;case"UPDATE_SETTINGS":await this.updateSettings(e.data),s({success:!0});break;case"GET_TAB_RESULTS":const o=undefined;s({results:this.tabResults.get(t.tab?.id)||[]});break;case"CLEAR_TAB_RESULTS":this.tabResults.delete(t.tab?.id),s({success:!0});break;case"EXPORT_SESSION_DATA":const n=undefined;s({data:await this.getSessionData()});break;case"SHOW_NOTIFICATION":await this.showNotification(e.data),s({success:!0});break;case"API_CALL_CAPTURED":this.handleApiCall(e.data,t.tab?.id),s({success:!0});break;case"PROXY_REQUEST":return this.handleProxyRequest(e.data,e.tabId).then(s),!0;case"GET_API_ENDPOINTS":const r=undefined;s({endpoints:this.apiEndpoints.get(e.tabId)||[]});break;case"CLEAR_API_ENDPOINTS":this.apiEndpoints.set(e.tabId,[]),s({success:!0});break;default:console.warn("Unknown message type:",e.type),s({error:"Unknown message type"})}}catch(e){console.error("Error handling message:",e),s({error:e.message})}}async handleScanComplete(e,t){if(!t)return;const s=undefined,o=[...this.tabResults.get(t)||[],...e.findings];if(this.tabResults.set(t,o),this.settings.enableNotifications){const t=e.findings.filter((e=>"critical"===e.riskLevel||"high"===e.riskLevel));t.length>0&&await this.showNotification({type:"credential_detected",title:"ðŸš¨ Credentials Detected",message:`Found ${t.length} high-risk credential(s)`,findings:t})}await this.updateBadge(t,o.length)}handleApiCall(e,t){if(!t)return;const s=this.apiEndpoints.get(t)||[],o=undefined;s.some((t=>t.method===e.method&&t.url===e.url))||(s.push(e),this.apiEndpoints.set(t,s),this.notifyExplorerTabs(t,e))}async notifyExplorerTabs(e,t){try{const s=await("undefined"!=typeof browser?browser:chrome).tabs.query({});for(const o of s)o.url&&o.url.includes("popup/explorer.html")&&o.url.includes(`tabId=${e}`)&&("undefined"!=typeof browser?browser:chrome).tabs.sendMessage(o.id,{type:"NEW_API_ENDPOINT",tabId:e,endpoint:t}).catch((e=>{console.debug("Could not notify explorer tab:",e.message)}))}catch(e){console.error("Error notifying explorer tabs:",e)}}async handleProxyRequest(e,t){try{console.log("ðŸ”„ [Background] Forwarding proxy request to Content Script"),console.log("ðŸ”„ [Background] Request data:",e),console.log("ðŸ”„ [Background] Target tab ID:",t);const s="undefined"!=typeof browser?browser:chrome;let o;if(t)try{o=await s.tabs.get(t),console.log("âœ… [Background] Found specified tab:",o.id,o.url)}catch(e){console.warn(`âš ï¸ [Background] Specified tab ${t} not found:`,e.message)}if(!o){const e=await s.tabs.query({active:!0,currentWindow:!0});if(!e||0===e.length)throw console.error("âŒ [Background] No active tab found"),new Error("No active tab found to execute request");o=e[0],console.log("ðŸ“ [Background] Using active tab:",o.id,o.url)}if(console.log(`ðŸŽ¯ [Background] Target Tab: ID=${o.id}, URL=${o.url}`),o.url.startsWith("chrome://")||o.url.startsWith("edge://")||o.url.startsWith("about:")||o.url.startsWith("moz-extension://"))throw console.warn("âš ï¸ [Background] Target tab is a restricted page. Content script likely missing."),new Error("Cannot inject content script into restricted page");const n=async()=>{console.log("ðŸ“¤ [Background] Sending executeRequest to tab",o.id);const t=await s.tabs.sendMessage(o.id,{action:"executeRequest",data:e});return console.log("ðŸ“¥ [Background] Received response from content script:",t),t};try{const e=await n();return console.log("âœ… [Background] Proxy request successful"),e}catch(e){console.error("âŒ [Background] sendMessage failed:",e.message);const t=undefined;if(!(e.message.includes("Receiving end does not exist")||e.message.includes("Could not establish connection"))||o.url.startsWith("about:")||o.url.startsWith("chrome"))throw e;{console.log("âš ï¸ [Background] Content script disconnected. Attempting lazy injection...");const e=["config/patterns.js","utils/storage.js","utils/context.js","utils/bucket-parser.js","utils/bucket-tester.js","utils/settings.js","utils/scanner.js","content.js"];for(const t of e)try{console.log(`ðŸ’‰ [Background] Injecting ${t}...`),s.scripting?await s.scripting.executeScript({target:{tabId:o.id},files:[t]}):await s.tabs.executeScript(o.id,{file:t})}catch(e){console.error(`âŒ [Background] Failed to inject ${t}:`,e)}await new Promise((e=>setTimeout(e,500))),console.log("ðŸ”„ [Background] Retrying proxy request after injection...");const t=await n();return console.log("âœ… [Background] Retry successful"),t}}}catch(e){return console.error("âŒ [Background] Proxy forwarding failed:",e),{success:!1,error:`Proxy Error: ${e.message}`}}}async updateSettings(e){const t=this.validateSettings(e);this.settings={...this.settings,...t};try{await chrome.storage.local.set({userSettings:this.settings});const e=await chrome.tabs.query({});for(const t of e)try{await chrome.tabs.sendMessage(t.id,{type:"SETTINGS_UPDATED",data:this.settings})}catch(e){}}catch(e){throw console.error("Failed to save settings:",e),e}}validateSettings(e){const t={...e};if(t.cloudBucketScanning){const e=t.cloudBucketScanning;if("boolean"!=typeof e.enabled&&(e.enabled=!0),e.providers&&"object"==typeof e.providers){const t=undefined;["aws","gcp","azure","digitalocean","alibaba"].forEach((t=>{"boolean"!=typeof e.providers[t]&&(e.providers[t]=!0)}))}else e.providers={aws:!0,gcp:!0,azure:!0,digitalocean:!0,alibaba:!0};("number"!=typeof e.testTimeout||e.testTimeout<1e3||e.testTimeout>3e4)&&(e.testTimeout=5e3),("number"!=typeof e.maxConcurrentTests||e.maxConcurrentTests<1||e.maxConcurrentTests>10)&&(e.maxConcurrentTests=3),"boolean"!=typeof e.testPublicAccess&&(e.testPublicAccess=!0)}return t}async showNotification(e){if(!this.settings.enableNotifications)return;const t={type:"basic",iconUrl:chrome.runtime.getURL("icons/icon-48.png"),title:e.title||"Credential Scanner",message:e.message||"Credentials detected",priority:e.findings?.some((e=>"critical"===e.riskLevel))?2:1};try{const e=await chrome.notifications.create(t);setTimeout((()=>{chrome.notifications.clear(e)}),5e3)}catch(e){console.error("Failed to show notification:",e)}}async updateBadge(e,t){const s=t>0?t.toString():"",o=t>0?"#dc3545":"#28a745";try{await chrome.browserAction.setBadgeText({text:s,tabId:e}),await chrome.browserAction.setBadgeBackgroundColor({color:o,tabId:e})}catch(e){console.error("Failed to update badge:",e)}}setupStorageListeners(){chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.userSettings&&(this.settings=e.userSettings.newValue,console.log("Settings updated from storage"))}))}setupTabListeners(){chrome.tabs.onRemoved.addListener((e=>{this.tabResults.delete(e),this.apiEndpoints.delete(e)})),chrome.tabs.onUpdated.addListener(((e,t)=>{"loading"===t.status&&(this.tabResults.delete(e),this.apiEndpoints.delete(e),this.updateBadge(e,0))}))}async getSessionData(){const e=[];for(const[t,s]of this.tabResults.entries())try{const o=await chrome.tabs.get(t);e.push({tabId:t,url:o.url,title:o.title,findings:s,timestamp:Date.now()})}catch(e){}return{sessionId:Date.now().toString(),exportDate:(new Date).toISOString(),totalFindings:e.reduce(((e,t)=>e+t.findings.length),0),totalTabs:e.length,settings:this.settings,tabs:e}}}class ChromeAPIAdapter{static adaptFirefoxToChrome(){"undefined"==typeof browser&&"undefined"!=typeof chrome&&(window.browser={runtime:{sendMessage:chrome.runtime.sendMessage.bind(chrome.runtime),onMessage:chrome.runtime.onMessage,getURL:chrome.runtime.getURL.bind(chrome.runtime)},storage:{local:{get:e=>new Promise((t=>chrome.storage.local.get(e,t))),set:e=>new Promise((t=>chrome.storage.local.set(e,t)))},onChanged:chrome.storage.onChanged},tabs:{query:e=>new Promise((t=>chrome.tabs.query(e,t))),sendMessage:(e,t)=>new Promise((s=>chrome.tabs.sendMessage(e,t,s)))},notifications:{create:e=>new Promise((t=>chrome.notifications.create(e,t))),clear:chrome.notifications.clear.bind(chrome.notifications)}})}}function isChromeExtension(){return"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.id}function getExtensionAPI(){if("undefined"!=typeof browser)return browser;if("undefined"!=typeof chrome)return ChromeAPIAdapter.adaptFirefoxToChrome(),browser;throw new Error("No extension API available")}self.addEventListener("install",(e=>{console.log("ðŸ”§ Service worker installing..."),self.skipWaiting()})),self.addEventListener("activate",(e=>{console.log("âœ… Service worker activated"),e.waitUntil(clients.claim())}));const activeProxyTargets=new Set;self.activeProxyTargets=activeProxyTargets,function(){try{const e=undefined,t=("undefined"!=typeof browser?browser:chrome).webRequest||("undefined"!=typeof chrome?chrome.webRequest:null);t&&t.onBeforeSendHeaders?(console.log("âœ… [TOP-LEVEL] Setting up webRequest listener"),t.onBeforeSendHeaders.addListener((e=>{let t=!1;const s=e.requestHeaders||[];for(let o=0;o<s.length;o++)if("X-FW-Proxy"===s[o].name){t=!0,s.splice(o,1),console.log("ðŸŽ¯ [PROXY] Intercepted request with marker:",e.url);break}const o=activeProxyTargets.has(e.url);if(t||o){const n=new URL(e.url),r=n.origin;o&&!t&&console.log(`ðŸ”Ž [PROXY] Intercepted Preflight/Related request: ${e.method} ${e.url}`);let a=!1;for(const e of s)"origin"===e.name.toLowerCase()?(console.log(`ðŸ”„ [PROXY] Rewriting Origin: ${e.value} -> ${r}`),e.value=r,a=!0):"referer"===e.name.toLowerCase()&&(console.log(`ðŸ”„ [PROXY] Rewriting Referer: ${e.value} -> ${n.href}`),e.value=n.href);return a||(console.log(`âž• [PROXY] Adding Origin: ${r}`),s.push({name:"Origin",value:r}),s.some((e=>"referer"===e.name.toLowerCase()))||s.push({name:"Referer",value:n.href})),{requestHeaders:s}}}),{urls:["<all_urls>"]},"undefined"!=typeof browser?["blocking","requestHeaders"]:["blocking","requestHeaders","extraHeaders"])):console.error("âŒ [TOP-LEVEL] webRequest API not available!")}catch(e){console.error("âŒ [TOP-LEVEL] CRITICAL ERROR during webRequest setup:",e)}}();let backgroundService=null;try{backgroundService=new BackgroundService}catch(e){console.error("âŒ Failed to initialize background service:",e)}chrome.runtime.onStartup.addListener((()=>{console.log("ðŸš€ Extension startup"),backgroundService||(backgroundService=new BackgroundService)})),chrome.runtime.onInstalled.addListener((e=>{console.log("ðŸ“¦ Extension installed/updated:",e.reason),backgroundService||(backgroundService=new BackgroundService)})),"undefined"!=typeof module&&module.exports&&(module.exports={BackgroundService:BackgroundService,ChromeAPIAdapter:ChromeAPIAdapter});