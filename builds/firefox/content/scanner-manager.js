!function(){"use strict";const e="undefined"!=typeof browser?browser:chrome,t=window.FerretWatchUtils||{},n=t.debugLog||function(){},i=t.infoLog||function(){},o=window.FerretWatchWhitelist||{},s=o.isDomainWhitelisted||function(){return!1},r=o.getCurrentDomain||function(){return window.location.hostname},a=window.FerretWatchNotifications||{},c=a.showBucketNotification,l=a.showRegularNotification;let u={maxFindings:50,scanningMode:"progressive",scanDelay:500,enableDebounce:!0,enabledCategories:{aws:!0,github:!0,slack:!0,discord:!0,apiKeys:!0,azure:!0,gcp:!0,jwt:!0,services:!0,passwords:!0,keys_and_certificates:!0,database:!0,environment:!0},cloudBucketScanning:{enabled:!0,providers:{aws:!0,gcp:!0,azure:!0,digitalocean:!0,alibaba:!0},testTimeout:5e3,maxConcurrentTests:3,testPublicAccess:!0}},d=null,g=[],f=new Set;async function w(){try{if(!e.storage)return void n("Storage API not available");const t=await e.storage.local.get(["userSettings","debugMode"]);t.userSettings&&(u={...u,...t.userSettings}),void 0!==t.debugMode&&(u.debugMode=t.debugMode),n("Settings loaded:",u)}catch(e){n("Failed to load settings:",e)}}function h(e,t){return void 0!==u[e]?u[e]:t}function S(e){if(g=e.map((e=>({...e,timestamp:(new Date).toISOString(),url:window.location.href,domain:window.location.hostname}))),window.lastScanResults=g,0===e.length)return void i("âœ… No security issues found on this page.");const t=e.filter((e=>e.bucketInfo)),o=e.filter((e=>!e.bucketInfo)),s=e.filter((e=>"critical"===e.riskLevel)).length,r=e.filter((e=>"high"===e.riskLevel)).length,a=e.filter((e=>"medium"===e.riskLevel)).length;i(s>0||r>0?`ðŸš¨ SECURITY ALERT: Found ${s+r} high-risk issue(s) on ${window.location.hostname}`:a>0?`âš ï¸ Found ${a} medium-risk issue(s) on ${window.location.hostname}`:`â„¹ï¸ Found ${e.length} low-risk issue(s) on ${window.location.hostname}`);const u=undefined;e.filter((e=>["critical","high","medium"].includes(e.riskLevel))).forEach(((e,t)=>{const n={critical:"ðŸ”¥",high:"ðŸš¨",medium:"âš ï¸",low:"â„¹ï¸"}[e.riskLevel]||"â“";if(e.bucketInfo){const t=e.bucketInfo.testResults?.listingEnabled?"PUBLIC LISTING":e.bucketInfo.testResults?.accessible?"ACCESSIBLE":"SECURED";i(`${n} [${e.riskLevel?.toUpperCase()}] ${e.type}: ${e.value} (${t})`)}else i(`${n} [${e.riskLevel?.toUpperCase()}] ${e.type}: ${e.value}`)}));const d=e.filter((e=>{const t=`${e.type}:${e.value}`;return!f.has(t)&&(f.add(t),!0)})),w=d.filter((e=>"low"!==(e.riskLevel||"medium"))),h=e.filter((e=>"low"!==(e.riskLevel||"medium")));if(w.length>0||h.length>0){const e=w.filter((e=>e.bucketInfo)),t=w.filter((e=>!e.bucketInfo)),n=h.filter((e=>e.bucketInfo)),i=h.filter((e=>!e.bucketInfo));n.length>0&&c?c(n,e):i.length>0&&l&&l(i,t)}else n("Same findings detected (notification dismissed - check console for details)");const S=d.filter((e=>"low"===(e.riskLevel||"medium")));S.length>0&&n(`${S.length} low-risk finding(s) detected (informational only - not shown in popup)`)}async function m(){if(!d)return console.error("[FW Scanner] Scanner not initialized"),[];const e=[];if(window.SECURITY_PATTERNS)for(const t in window.SECURITY_PATTERNS)for(const n in window.SECURITY_PATTERNS[t]){const i=window.SECURITY_PATTERNS[t][n];i.pattern&&e.push({regex:i.pattern,type:i.description,risk:i.riskLevel,riskLevel:i.riskLevel,category:i.category||t,provider:i.provider})}const t=document.documentElement.innerHTML;let i=await d.progressiveScan(t,e);if(d.isBucketScanningEnabled&&"function"==typeof d.isBucketScanningEnabled&&d.isBucketScanningEnabled())try{const e=await d.scanCloudBuckets(i);if(e&&e.length>0){const t=i.filter((e=>!e.category||"cloudStorage"!==e.category));i=[...t,...e]}}catch(e){n("Bucket scanning failed:",e)}return S(i),i}async function k(){try{const e=r();if(console.log("[FW Content] Initializing FerretWatch scanner on domain:",e),await w(),s())return void console.log("[FW Content] FerretWatch disabled for whitelisted domain:",e);console.log("[FW Content] FerretWatch starting scan on:",e),n("FerretWatch Auto-scanning for credentials..."),await m()}catch(e){console.error("[FW Content] Initialization error:",e)}}function b(e){d=e}function v(){return d}function p(){return g}function y(){f.clear()}window.FerretWatchScanner={initializeScanner:k,runScan:m,loadSettings:w,getSetting:h,processFindings:S,setScanner:b,getScanner:v,getLastScanResults:p,resetSeenCredentials:y},window.StorageUtils={get:async t=>{if(!e.storage)return null;const n=undefined;return(await e.storage.local.get([t]))[t]||null},set:async(t,n)=>{e.storage&&await e.storage.local.set({[t]:n})},remove:async t=>{e.storage&&await e.storage.local.remove([t])},isDomainWhitelisted:(e=null)=>s(e),getSetting:(e,t)=>h(e,t)}}();